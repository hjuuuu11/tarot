<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”®AI å¡”ç¾…å¸«ğŸ”®</title>
  <style>
    body {
      font-family: "PMingLiU", "MingLiU", "SimSun", "serif";
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #F1E1FF; 
      color: #4b0082;
    }

    h1 {
      text-align: center;
      font-size: 2.5em;
      color: #6a0dad;
      margin-bottom: 1em;
      position: relative;
    }

    .form-group {
      margin-bottom: 15px;
    }

    textarea {
      width: 100%;
      height: 180px; 
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 2px solid #d8b4fe;
      font-family: "PMingLiU", "MingLiU", "SimSun", "serif";
      resize: vertical;
    }

    .reading-result {
      white-space: pre-wrap;
      margin-top: 20px;
      padding: 15px;
      border: 2px dashed #c084fc;
      border-radius: 15px;
      min-height: 150px;
      background-color: #fdf4ff;
    }

    .card-selection {
      margin: 20px 0;
    }

    #cardImages {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      justify-items: center;
    }

    .card {
      text-align: center;
      cursor: pointer;
      user-select: none;
      width: 100px;
      border-radius: 10px;
    }

    .card img {
      width: 100px;
      height: 160px;
      transition: transform 0.6s ease;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: block;
      margin: 0 auto;
    }

    .reversed {
      transform: rotate(180deg);
    }

    .card-label {
      margin-top: 6px;
      font-weight: bold;
      font-size: 14px;
      min-height: 36px;
    }

    .selected {
      outline: 4px solid #a855f7;
      border-radius: 12px;
    }

    .color-box {
      display: inline-block;
      width: 60px;
      height: 60px;
      border: 2px solid #000;
      vertical-align: middle;
      margin-left: 10px;
      border-radius: 4px; 
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    #navButtons {
      display: none;
    }

    .button-group {
      margin-top: 20px;
      text-align: center;
    }

    button {
      padding: 10px 20px;
      margin: 0 10px;
      font-size: 16px;
      border-radius: 8px;
      background: #c084fc;
      border: none;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
      font-family: inherit;
    }

    button:hover {
      background: #a855f7;
    }

    video,
    canvas {
      border-radius: 10px;
      border: 2px solid #d8b4fe;
    }

    ol li {
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <h1>ğŸ”® AI å¡”ç¾…å¸« ğŸ”®</h1>

  <!-- Step 0 -->
  <div id="step0" class="step active">
    <p>æ­¡è¿è¸å…¥ AI å¡”ç¾…å åœçš„ç¥ç§˜ä¸–ç•Œã€‚åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°‡é€éç²¾æº–çš„ä¸‰éšæ®µæµç¨‹ï¼Œé™ªä¼´ä½ æ¢ç´¢å…§å¿ƒæ·±è™•çš„çœŸå¯¦è²éŸ³ï¼š</p>
    <ol>
      <li>è«‹èª å¿ƒè¼¸å…¥ä½ æœ€é—œæ³¨çš„å•é¡Œï¼Œè®“å åœèšç„¦æ–¼ä½ çš„æ ¸å¿ƒè­°é¡Œ</li>
      <li>é¸æ“‡ä¸€ä»¶ä»£è¡¨ä½ ç•¶ä¸‹å¿ƒå¢ƒçš„ç‰©å“ï¼Œç³»çµ±å°‡é€éè‰²å½©èƒ½é‡è§£æä½ çš„æƒ…ç·’æ³¢å‹•</li>
      <li>æŠ½å–ä¸‰å¼µå¡”ç¾…ç‰Œï¼Œçµåˆ AI æ™ºæ…§ï¼Œç‚ºä½ æ­ç¤ºæ½›è—çš„æŒ‡å¼•èˆ‡å•Ÿç¤º</li>
    </ol>
    <div class="button-group">
      <button onclick="startFlow()">é–‹å§‹å åœ</button>
    </div>
  </div>
  
  <!-- Step 1: è¼¸å…¥å•é¡Œ -->
  <div id="step1" class="step">
    <div class="form-group">
      <label style="display: block; margin-bottom: 16px;">ä½ çš„å•é¡Œ:</label>
      <textarea id="question" style="width: 100%; height: 50px; font-size: 16px; padding: 8px; border-radius: 8px;"></textarea>
    </div>
  </div>

  <!-- Step 2: é¡è‰²æ“·å– -->
  <div id="step2" class="step">
    <div class="form-group">
      <label>ä½ å–œæ­¡çš„é¡è‰²ï¼ˆå¾ç•«é¢ä¸­æˆªå–ï¼‰:</label>
      <input type="text" id="color" readonly />
      <span id="colorPreview" class="color-box"></span><br />
      <button onclick="startCamera()">é–‹å•Ÿæ”å½±æ©Ÿ</button>
      <button onclick="captureColor()">æˆªå–é¡è‰²</button>
    </div>
    <video id="videoContainer" autoplay width="320" height="240" style="display: none;"></video>
    <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
  </div>

  <!-- Step 3: é¸ç‰Œèˆ‡è§£è®€ -->
  <div id="step3" class="step">
    <div class="card-selection">
      <label style="display: block; margin-bottom: 16px;">
        è«‹å¾ä¸‹æ–¹10å¼µç‰Œä¸­é¸æ“‡ä½ æƒ³è¦çš„3å¼µç‰Œï¼š
      </label>
      <div id="cardImages"></div>
    </div>
    <div class="button-group">
      <button onclick="drawCards()">é‡æ–°æŠ½ç‰Œ</button>
      <button onclick="getReading()">å–å¾—è§£è®€</button>
    </div>
    <div id="result" class="reading-result"></div>
    <div class="button-group">
      <button onclick="restartFlow()">ğŸ”„ é‡æ–°é–‹å§‹å åœ</button>
    </div>
  </div>

  <!-- åˆ†é æ§åˆ¶ -->
  <div id="navButtons" class="button-group">
    <button id="prevBtn" onclick="changeStep(-1)">ä¸Šä¸€æ­¥</button>
    <button id="nextBtn" onclick="changeStep(1)">ä¸‹ä¸€æ­¥</button>
  </div>

<script>

  const tarotCards = [
    "æ„šè€…", "é­”è¡“å¸«", "å¥³ç¥­å¸", "å¥³çš‡", "çš‡å¸", "æ•™çš‡", "æˆ€äºº", "æˆ°è»Š",
    "åŠ›é‡", "éš±è€…", "å‘½é‹ä¹‹è¼ª", "æ­£ç¾©", "å€’åŠäºº", "æ­»ç¥", "ç¯€åˆ¶", "æƒ¡é­”",
    "é«˜å¡”", "æ˜Ÿæ˜Ÿ", "æœˆäº®", "å¤ªé™½", "å¯©åˆ¤", "ä¸–ç•Œ"
  ];
  let displayedCards = [];
  let currentStep = 0;
  let videoStream;

  function startFlow() {
    changeStep(1);
    document.getElementById('prevBtn').disabled = true;
  }

  function changeStep(direction) {
    if (direction === 1) {
      if (currentStep === 1 && !document.getElementById('question').value.trim()) {
        alert('è«‹å…ˆè¼¸å…¥ä½ çš„å•é¡Œ'); return;
      }
      if (currentStep === 2 && !document.getElementById('color').value) {
        alert('è«‹å…ˆæˆªå–é¡è‰²'); return;
      }
    }

    currentStep += direction;
    if (currentStep < 1) currentStep = 1;
    if (currentStep > 3) currentStep = 3;

    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${currentStep}`).classList.add('active');
    // æ–°å¢åˆ¤æ–·æ˜¯å¦è¦é¡¯ç¤ºæ•´å€‹æŒ‰éˆ•å€å¡Š
      const nav = document.getElementById('navButtons');
    if (currentStep === 0 || currentStep === 3) {
      nav.style.display = 'none';  // ç¬¬ä¸€æ­¥èˆ‡ç¬¬ä¸‰æ­¥éƒ½éš±è—æ•´å€‹æŒ‰éˆ•å€å¡Š
    } else {
      nav.style.display = 'block'; // å…¶ä»–æ­¥é©Ÿé¡¯ç¤º
    }

      document.getElementById('prevBtn').disabled = currentStep === 1;
      document.getElementById('nextBtn').disabled = currentStep === 3;

      if (currentStep === 3 && displayedCards.length === 0) drawCards();
    }
  function drawCards() {
    const available = [...tarotCards];
    displayedCards = [];
    const container = document.getElementById('cardImages');
    container.innerHTML = '';

    for (let i = 0; i < 10; i++) {
      const idx = Math.floor(Math.random() * available.length);
      const name = available.splice(idx, 1)[0];
      const reversed = Math.random() < 0.5;
      displayedCards.push({ name, reversed, flipped: false, selected: false });

      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.index = i;

      const img = document.createElement('img');
      img.src = '/image/back.png';
      img.alt = 'å¡ç‰ŒèƒŒé¢';

      const label = document.createElement('div');
      label.className = 'card-label';
      label.textContent = '';

      div.appendChild(img);
      div.appendChild(label);
      container.appendChild(div);
      div.addEventListener('click', () => selectCard(i));
    }

    document.getElementById('result').textContent = '';
  }

  function selectCard(i) {
    const card = displayedCards[i];
    if (card.selected) {
      card.selected = false;
      card.flipped = false;
    } else {
      if (displayedCards.filter(c => c.selected).length >= 3) {
        alert('æœ€å¤šåªèƒ½é¸æ“‡ä¸‰å¼µç‰Œ'); return;
      }
      card.selected = true;
      card.flipped = true;
    }
    updateCardDisplay(i);
  }

  function updateCardDisplay(i) {
    const card = displayedCards[i];
    const div = document.querySelector(`.card[data-index='${i}']`);
    const img = div.querySelector('img');
    const label = div.querySelector('.card-label');

    if (card.flipped) {
      img.src = '/image/front.png';
      card.reversed ? img.classList.add('reversed') : img.classList.remove('reversed');
      label.textContent = `${card.name}ï¼ˆ${card.reversed ? 'é€†ä½' : 'æ­£ä½'}ï¼‰`;
    } else {
      img.src = '/image/back.png';
      img.classList.remove('reversed');
      label.textContent = '';
    }

    card.selected ? div.classList.add('selected') : div.classList.remove('selected');
  }

  async function startCamera() {
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video = document.getElementById('videoContainer');
      video.srcObject = videoStream;
      video.style.display = 'block';
    } catch (e) {
      alert('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ');
    }
  }

  function captureColor() {
    const video = document.getElementById('videoContainer');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const pixel = ctx.getImageData(canvas.width / 2, canvas.height / 2, 1, 1).data;
    const hex = `#${pixel[0].toString(16).padStart(2, '0')}${pixel[1].toString(16).padStart(2, '0')}${pixel[2].toString(16).padStart(2, '0')}`;

    document.getElementById('color').value = hex;
    document.getElementById('colorPreview').style.backgroundColor = hex;

    // é€™è£¡é—œé–‰æ”å½±æ©Ÿ
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
      video.srcObject = null;
      video.style.display = 'none';
      videoStream = null;  // æ¸…é™¤ä¸²æµç‰©ä»¶
    }
  }
  async function getReading() {
    const selected = displayedCards.filter(c => c.selected);
    if (selected.length !== 3) {
      alert('è«‹é¸æ“‡ä¸‰å¼µç‰Œ'); return;
    }

    const question = document.getElementById('question').value;
    const color = document.getElementById('color').value;
    const cards = selected.map(c => `${c.name}ï¼ˆ${c.reversed ? 'é€†ä½' : 'æ­£ä½'}ï¼‰`);

    const resultDiv = document.getElementById('result');
    resultDiv.textContent = `ä½ çš„å•é¡Œæ˜¯ï¼šã€Œ${question}ã€\n\nä½ çš„é¡è‰²æ˜¯ï¼š${color}\n\nä½ é¸çš„ç‰Œæ˜¯ï¼š\n${cards.join('ã€')}\n\nğŸ”® è«‹ç¨å€™ï¼ŒAI æ­£åœ¨åˆ†æä½ çš„èƒ½é‡èˆ‡å‘½é‹...`;

    try {
      const response = await fetch('/reading', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, color, cards })
      });

      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }

      const data = await response.json();
      resultDiv.textContent = `ä½ çš„å•é¡Œæ˜¯ï¼šã€Œ${question}ã€\n\nä½ çš„é¡è‰²æ˜¯ï¼š${color}ã€‚\n\nä½ é¸çš„ç‰Œæ˜¯ï¼š\n${cards.join('ã€')}\n\nğŸ”® AI è§£è®€å¦‚ä¸‹ï¼š\n\n${data.result}`;
    } catch (error) {
      resultDiv.textContent = 'âš ï¸ è§£è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\néŒ¯èª¤è³‡è¨Šï¼š' + error.message;
    }
  }
  function restartFlow() {
    // æ¸…é™¤æ‰€æœ‰è³‡æ–™
    currentStep = 0;
    document.getElementById('question').value = '';
    document.getElementById('color').value = '';
    document.getElementById('colorPreview').style.backgroundColor = 'transparent';
    document.getElementById('result').textContent = '';
    displayedCards = [];
    document.getElementById('cardImages').innerHTML = '';

    // éš±è—æ”å½±æ©Ÿèˆ‡ç•«å¸ƒ
    if (videoStream) {
      const tracks = videoStream.getTracks();
      tracks.forEach(track => track.stop());
      videoStream = null;
    }
    document.getElementById('videoContainer').style.display = 'none';
    document.getElementById('canvas').style.display = 'none';

    // é¡¯ç¤ºåˆå§‹é é¢
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step0').classList.add('active');
    document.getElementById('navButtons').style.display = 'none';
  }
</script>
</body>
</html>